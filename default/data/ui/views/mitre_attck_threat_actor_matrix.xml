<form script="mitre_threat_actor_triggered.js" stylesheet="mitre_matrix.css" theme="dark" version="1.1">
  <label>MITRE ATT&amp;CK Threat Actor Matrix</label>
  <description>This dashboard provides an overview of triggered threat actors and techniques based on enabled correlation rules with related MITRE ATT&amp;CK annotations.</description>
  <search id="mitre_use_es">
    <query>| makeresults | eval mitre_use_es=`mitre_use_es` | eval results=if(mitre_use_es=="1",1,null()) | table results</query>
    <done>
      <condition match=" $job.resultCount$ &gt; 0">
        <set token="mitre_use_es">1</set>
      </condition>
      <condition match=" $job.resultCount$ == 0">
        <set token="mitre_use_es">0</set>
      </condition>
    </done>
  </search>
  <search id="init_attack_search">
    <query>
    `mitre_rules`
    | fields rule_name, urgency, score, technique_id, technique_name, actor_id, actor_name
    | stats count as triggered_count list(rule_name) as rule_name_list, max(score) as max_score by technique_id
    | eval rule_name_list=mvjoin(mvdedup(rule_name_list),";")
    | search [ | inputlookup mitre_group_technique_lookup
        | eval technique_id_list=split(technique_id," ")
        | mvexpand technique_id_list
        | fields technique_id_list
        | rename technique_id_list AS technique_id ]
    </query>
    <earliest>$attack_time_field.earliest$</earliest>
    <latest>$attack_time_field.latest$</latest>
    <done>
      <condition>
        <set token="subsearch_id">$job.sid$</set>
      </condition>
    </done>
  </search>
  <search id="init_mitre_attack_table">
    <query>
          | inputlookup $tok_display_option$
          | foreach all_techniques G*
    [| lookup mitre_threat_actor_technique_lookup technique_id as &lt;&lt;FIELD&gt;&gt; OUTPUT technique_name as &lt;&lt;FIELD&gt;&gt;_technique_name
    | eval &lt;&lt;FIELD&gt;&gt;_technique_name=mvindex(&lt;&lt;FIELD&gt;&gt;_technique_name,0)]
    </query>
  </search>
  <search base="init_mitre_attack_table" id="post_process_mitre_attack_triage">
    <query>
  | join type=left
      [| loadjob $subsearch_id$
      | rename technique_id as G0018, triggered_count as G0018_attack_count, rule_name_list as G0018_rule_name_list, max_score as G0018_max_score ]
      | fillnull value="NULL" G0018,G0018_rule_name_list,G0018_technique_name
      | fillnull value=0 G0018_attack_count,G0018_max_score
      | eval G0018=G0018."|".G0018_technique_name."|".G0018_attack_count."|".G0018_rule_name_list."|".G0018_max_score  
  | join type=left
      [| loadjob $subsearch_id$
      | rename technique_id as G1030, triggered_count as G1030_attack_count, rule_name_list as G1030_rule_name_list, max_score as G1030_max_score ]
      | fillnull value="NULL" G1030,G1030_rule_name_list,G1030_technique_name
      | fillnull value=0 G1030_attack_count,G1030_max_score
      | eval G1030=G1030."|".G1030_technique_name."|".G1030_attack_count."|".G1030_rule_name_list."|".G1030_max_score
  | join type=left
    [| loadjob $subsearch_id$
    | rename technique_id as G0130, triggered_count as G0130_attack_count, rule_name_list as G0130_rule_name_list, max_score as G0130_max_score ]
    | fillnull value="NULL" G0130,G0130_rule_name_list,G0130_technique_name
    | fillnull value=0 G0130_attack_count,G0130_max_score
    | eval G0130=G0130."|".G0130_technique_name."|".G0130_attack_count."|".G0130_rule_name_list."|".G0130_max_score
  | join type=left
    [| loadjob $subsearch_id$
    | rename technique_id as all_techniques, triggered_count as all_techniques_attack_count, rule_name_list as all_techniques_rule_name_list, max_score as all_techniques_max_score ]
    | fillnull value="NULL" all_techniques,all_techniques_rule_name_list,all_techniques_technique_name
    | fillnull value=0 all_techniques_attack_count,all_techniques_max_score
    | eval all_techniques=all_techniques."|".all_techniques_technique_name."|".all_techniques_attack_count."|".all_techniques_rule_name_list."|".all_techniques_max_score
</query>
  </search>
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="attack_time_field" searchWhenChanged="false">
      <label>Event Time Range</label>
      <default>
        <earliest>-15m</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="multiselect" token="urgency_field" searchWhenChanged="false">
      <label>Urgency</label>
      <choice value="critical">Critical</choice>
      <choice value="high">High</choice>
      <choice value="medium">Medium</choice>
      <choice value="informational">Info</choice>
      <choice value="low">Low</choice>
      <default>critical,high,medium,informational,low</default>
      <delimiter> OR </delimiter>
      <valuePrefix>urgency=</valuePrefix>
      <prefix>(</prefix>
      <suffix>)</suffix>
    </input>
    <input type="radio" token="tok_display_option" searchWhenChanged="true">
      <label>Matrix Display Options</label>
      <choice value="mitre_threat_actor_lookup">Hide/Collapse Sub-techniques</choice>
      <choice value="mitre_threat_actor_lookup_subtechniques">Show/Expand Sub-techniques</choice>
      <default>mitre_threat_actor_lookup</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>MITRE ATT&amp;CK Threat Actors</title>
      <table id="mitretitle">
        <search base="post_process_mitre_attack_triage">
          <query>|  stats sum(G0018_attack_count) as G0018_sum
, sum(G1030_attack_count) as G1030_sum
, sum(G0130_attack_count) as G0130_sum
, sum(all_techniques_attack_count) as all_techniques_sum
, max(G0018_max_score) as G0018_max_score
, max(G1030_max_score) as G1030_max_score
, max(G0130_max_score) as G0130_max_score
, max(all_techniques_max_score) as all_techniques_max_score
| eval G0018=G0018_sum."|".G0018_max_score
, G1030=G1030_sum."|".G1030_max_score
, G0130=G0130_sum."|".G0130_max_score
, all_techniques=all_techniques_sum."|".all_techniques_max_score
| table all_techniques, G0018, G1030, G0130
| rename all_techniques as "SIEM All Rules Techniques", G0018 as "admin@338", G1030 as "Agrius", G0130 as "Ajax Security Team"</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>MITRE ATT&amp;CK Threat Actor Framework</title>
      <html>
         <style>
            #highlight2 .string {
            color: #00FF00 !important;
           }
           #highlight2 .td {
            background-color: #FFFFFF !important;
           }
         </style>
       </html>
      <table id="mitrematrix">
        <search base="post_process_mitre_attack_triage">
          <query>| fields all_techniques, G0018, G1030, G0130 | rename all_techniques as "SIEM All Rules Techniques", G0018 as "admin@338", G1030 as "Agrius", G0130 as "Ajax Security Team"</query>
        </search>-<option name="count">100</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <condition match="'mitre_use_es' == &quot;1&quot;">
            <eval token="rules_q">if(mvindex(split('click.value2',"|"),3)!="NULL",mvindex(split(replace('click.value2',";","<![CDATA[&source=]]>"),"|"),3),"*")</eval>
            <link target="_blank">
              <![CDATA[/app/SplunkEnterpriseSecuritySuite/incident_review?earliest=$attack_time_field.earliest$&amp;latest=$attack_time_field.latest$&amp;urgency=critical&amp;urgency=high&amp;urgency=medium&amp;urgency=low&amp;urgency=informational&source=$rules_q|n$]]>
            </link>
          </condition>
          <condition match="'mitre_use_es' == &quot;0&quot;">
            <eval token="rules_q">if(mvindex(split('click.value2',"|"),3)!="NULL",mvindex(split(replace('click.value2',";","<![CDATA[&form.s_title=]]>"),"|"),3),"*")</eval>
            <link target="_blank">
              <![CDATA[/app/alert_manager/incident_posture?form.global_time.earliest=$attack_time_field.earliest$&form.global_time.latest=$attack_time_field.latest$&form.owner=*&form.alert=*&form.category=*&form.subcategory=*&form.tags=*&form.tags=[Untagged]&form.status=status!%3D"*resolved" status!%3D"suppressed"&form.s_incident_id=&form.s_title=$rules_q|n$&form.impact=*&form.urgency=*&form.priority=*&form.freeform=]]>
            </link>
          </condition>
        </drilldown>
      </table>
    </panel>
  </row>
</form>
